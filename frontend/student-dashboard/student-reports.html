<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Reports - SSPLP</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="student-dashboard.html">
                    <img src="logo..png" alt="SSPLP Logo" class="logo">
                    <span>SSPLP</span>
                </a>
            </div>
            <div class="nav-menu">
                <a href="student-dashboard.html" class="nav-link">Home</a>
                <a href="progress.html" class="nav-link">Progress</a>
                <a href="student-reports.html" class="nav-link active">Reports</a>
            </div>
            <button id="logoutBtn" class="btn-signin">Logout</button>
        </div>
    </nav>

    <section style="padding: 40px 0;">
        <div class="container">
            <h1><i class="fas fa-file-alt"></i> Performance Reports</h1>
            <p>View and download your academic performance reports</p>

            <div style="margin: 20px 0; display: flex; gap: 10px;">
                <button onclick="generateReport('monthly')" class="btn btn-primary">
                    <i class="fas fa-calendar-alt"></i> Monthly Report
                </button>
                <button onclick="generateReport('termly')" class="btn btn-secondary">
                    <i class="fas fa-calendar"></i> Termly Report
                </button>
                <button onclick="downloadReport()" class="btn btn-secondary">
                    <i class="fas fa-download"></i> Download PDF
                </button>
            </div>

            <div id="reportContent" class="card"></div>
        </div>
    </section>

    <script src="js/app.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('currentUser'));
        
        function generateReport(type) {
            const quizAttempts = JSON.parse(localStorage.getItem('quizAttempts') || '[]')
                .filter(a => a.studentId === user.id);
            const submissions = JSON.parse(localStorage.getItem('submissions') || '[]')
                .filter(s => s.studentId === user.id);
            const resourceAccess = JSON.parse(localStorage.getItem('resourceAccess') || '[]')
                .filter(r => r.studentId === user.id);
            
            const period = type === 'monthly' ? 30 : 90;
            const cutoff = Date.now() - (period * 86400000);
            
            const recentQuizzes = quizAttempts.filter(a => new Date(a.completedAt) > cutoff);
            const recentSubmissions = submissions.filter(s => new Date(s.submittedAt) > cutoff);
            const recentAccess = resourceAccess.filter(r => new Date(r.accessedAt) > cutoff);
            
            const avgScore = recentQuizzes.length > 0 
                ? Math.round(recentQuizzes.reduce((sum, a) => sum + a.score, 0) / recentQuizzes.length)
                : 0;
            
            const totalTime = recentAccess.reduce((sum, r) => sum + (r.timeSpent || 0), 0);
            
            const subjectPerformance = {};
            recentQuizzes.forEach(a => {
                const quiz = JSON.parse(localStorage.getItem('quizzes') || '[]').find(q => q.id === a.quizId);
                if (quiz) {
                    if (!subjectPerformance[quiz.subject]) subjectPerformance[quiz.subject] = [];
                    subjectPerformance[quiz.subject].push(a.score);
                }
            });
            
            const reportHTML = `
                <div style="padding: 30px;">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #6d28d9; padding-bottom: 20px;">
                        <h2>South Sudan Personalized Learning Platform</h2>
                        <h3>${type === 'monthly' ? 'Monthly' : 'Termly'} Performance Report</h3>
                        <p><strong>Student:</strong> ${user.name} | <strong>Grade:</strong> ${user.grade || 'N/A'}</p>
                        <p><strong>Report Period:</strong> ${new Date(cutoff).toLocaleDateString()} - ${new Date().toLocaleDateString()}</p>
                        <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                        <div style="text-align: center; padding: 20px; background: #f3f0ff; border-radius: 8px;">
                            <h3 style="color: #6d28d9; font-size: 2rem; margin: 0;">${avgScore}%</h3>
                            <p style="margin: 5px 0;">Average Score</p>
                        </div>
                        <div style="text-align: center; padding: 20px; background: #f3f0ff; border-radius: 8px;">
                            <h3 style="color: #6d28d9; font-size: 2rem; margin: 0;">${recentQuizzes.length}</h3>
                            <p style="margin: 5px 0;">Quizzes Completed</p>
                        </div>
                        <div style="text-align: center; padding: 20px; background: #f3f0ff; border-radius: 8px;">
                            <h3 style="color: #6d28d9; font-size: 2rem; margin: 0;">${totalTime}</h3>
                            <p style="margin: 5px 0;">Minutes Studied</p>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 30px;">Subject Performance</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <thead>
                            <tr style="background: #f3f0ff; border-bottom: 2px solid #6d28d9;">
                                <th style="padding: 12px; text-align: left;">Subject</th>
                                <th style="padding: 12px; text-align: center;">Attempts</th>
                                <th style="padding: 12px; text-align: center;">Average Score</th>
                                <th style="padding: 12px; text-align: center;">Grade</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(subjectPerformance).map(([subject, scores]) => {
                                const avg = Math.round(scores.reduce((a,b) => a+b, 0) / scores.length);
                                const grade = avg >= 80 ? 'A' : avg >= 70 ? 'B' : avg >= 60 ? 'C' : avg >= 50 ? 'D' : 'F';
                                const color = avg >= 70 ? '#10b981' : avg >= 60 ? '#f59e0b' : '#ef4444';
                                return `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 12px;">${subject}</td>
                                        <td style="padding: 12px; text-align: center;">${scores.length}</td>
                                        <td style="padding: 12px; text-align: center; color: ${color}; font-weight: 600;">${avg}%</td>
                                        <td style="padding: 12px; text-align: center; font-weight: 600;">${grade}</td>
                                    </tr>
                                `;
                            }).join('') || '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #6b7280;">No quiz data available</td></tr>'}
                        </tbody>
                    </table>
                    
                    <h3 style="margin-top: 30px;">Assignments</h3>
                    <p><strong>Submitted:</strong> ${recentSubmissions.length} | <strong>Graded:</strong> ${recentSubmissions.filter(s => s.status === 'graded').length}</p>
                    
                    <h3 style="margin-top: 30px;">Recommendations</h3>
                    <ul style="line-height: 1.8;">
                        ${avgScore >= 80 ? '<li>Excellent performance! Keep up the great work.</li>' : ''}
                        ${avgScore < 60 ? '<li>Consider scheduling tutoring sessions for additional support.</li>' : ''}
                        ${Object.entries(subjectPerformance).filter(([s, scores]) => scores.reduce((a,b) => a+b, 0) / scores.length < 60).map(([s]) => 
                            `<li>Focus more on ${s} - additional practice recommended.</li>`
                        ).join('')}
                        <li>Continue accessing learning resources regularly.</li>
                    </ul>
                    
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center; color: #6b7280;">
                        <p>This report is generated automatically by SSPLP</p>
                        <p>For questions, contact: j.anyar@alustudent.com</p>
                    </div>
                </div>
            `;
            
            document.getElementById('reportContent').innerHTML = reportHTML;
        }
        
        function downloadReport() {
            alert('Report download functionality:\n\nIn production, this would generate a PDF using a library like jsPDF.\n\nFor now, you can print this page (Ctrl+P) and save as PDF.');
            window.print();
        }
        
        // Generate monthly report by default
        document.addEventListener('DOMContentLoaded', () => {
            generateReport('monthly');
        });
    </script>
</body>
</html>
